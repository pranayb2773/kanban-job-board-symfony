<nav class="navbar navbar-light bg-white shadow-sm border-bottom">
    <div class="container-fluid px-3 py-2">
        <a class="navbar-brand fw-bold d-flex align-items-center mb-0" href="{{ path('app_dashboard') }}">
            <i class="bi bi-clipboard-check text-primary me-1"></i>
            <span class="d-none d-sm-inline">Job Tracker</span>
            <span class="d-inline d-sm-none">Jobs</span>
        </a>

        <div class="d-flex align-items-center gap-2 gap-sm-3">
            {# Job Board Dropdown #}
            <div class="dropdown">
                <a class="btn btn-link text-decoration-none text-dark dropdown-toggle d-flex align-items-center p-1 p-sm-2" href="#" id="jobBoardDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-briefcase me-1 d-none d-md-inline"></i>
                    <span class="small">Job Board</span>
                </a>
                <ul class="dropdown-menu" aria-labelledby="jobBoardDropdown" id="jobBoardDropdownMenu">
                    {% if app.user %}
                        {# Use Twig extension to fetch the latest 5 job boards #}
                        {% set user_boards = get_recent_job_boards() %}
                        {% if user_boards|length > 0 %}
                            <li class="px-3 py-2 border-bottom" data-role="recent-heading">
                                <small class="text-muted text-uppercase fw-semibold">Recent Boards</small>
                            </li>
                            {% for jobBoard in user_boards %}
                                <li data-role="recent-item">
                                    <a class="dropdown-item py-2 d-flex align-items-center" href="#">
                                        <i class="bi bi-kanban me-2"></i>
                                        <div class="flex-grow-1">
                                            <div class="text-truncate" style="max-width: 200px;">{{ jobBoard.name }}</div>
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                            <li data-role="recent-divider"><hr class="dropdown-divider my-1"></li>
                        {% else %}
                            <li class="px-3 py-2 text-muted small" data-role="recent-empty">No boards yet</li>
                        {% endif %}
                    {% endif %}
                    <li data-role="create-action">
                        <button type="button" class="dropdown-item py-2" data-bs-toggle="modal" data-bs-target="#createJobBoardModal">
                            <i class="bi bi-plus-circle me-2"></i>Create New Board
                        </button>
                    </li>
                </ul>
            </div>

            {# User Account Dropdown #}
            <div class="dropdown">
                <a class="btn btn-link text-decoration-none text-dark dropdown-toggle d-flex align-items-center p-1 p-sm-2 pe-0" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px; font-size: 0.75rem;">
                        {{ app.user.name|first|upper }}
                    </span>
                    <span class="small d-none d-md-inline">{{ app.user.name }}</span>
                    <span class="small d-inline d-md-none">Account</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li class="px-3 py-2 d-md-none border-bottom">
                        <small class="text-muted d-block mb-1">Signed in as</small>
                        <strong class="d-block text-truncate" style="max-width: 200px;">{{ app.user.name }}</strong>
                    </li>
                    <li><a class="dropdown-item py-2" href="{{ path('app_user_profile') }}"><i class="bi bi-person me-2"></i>Your Profile</a></li>
                    <li><a class="dropdown-item py-2" href="{{ path('app_user_profile') }}"><i class="bi bi-gear me-2"></i>Settings</a></li>
                    <li><hr class="dropdown-divider my-1"></li>
                    <li><a class="dropdown-item py-2 text-danger" href="{{ path('app_logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
                </ul>
            </div>
        </div>
    </div>

    {# Modal for creating job board #}
    <div class="modal fade" id="createJobBoardModal" tabindex="-1" aria-labelledby="createJobBoardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header align-items-center">
                    <h5 class="modal-title d-flex align-items-center mb-0" id="createJobBoardModalLabel">
                        <span class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; flex-shrink: 0;">
                            <i class="bi bi-plus-lg"></i>
                        </span>
                        <span>Create New Job Board</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="jobBoardModalFormContainer">
                    {{ render(path('fragment_job_board_modal')) }}
                </div>
            </div>
        </div>
    </div>
</nav>

{# Toast Container #}
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
    <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Hello, world! This is a toast message.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modalElement = document.getElementById('createJobBoardModal');

    const showToast = (message, type = 'success') => {
        const toastElement = document.getElementById('liveToast');
        const toastBody = toastElement.querySelector('.toast-body');

        toastBody.textContent = message;

        toastElement.classList.remove('text-bg-success', 'text-bg-danger');
        toastElement.classList.add(type === 'success' ? 'text-bg-success' : 'text-bg-danger');

        const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastElement);
        toastBootstrap.show();
    };

    const closeModal = () => {
        const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
        if (closeButton) {
            closeButton.click();
            return;
        }

        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    };

    const bindFormHandler = () => {
        const form = modalElement.querySelector('form');
        if (!form || form.dataset.ajaxBound) {
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const defaultButtonContent = submitButton ? submitButton.innerHTML : '';
        form.dataset.ajaxBound = 'true';

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
            }

            let data;
            let response;
            try {
                response = await fetch(form.action, {
                    method: 'POST',
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    body: new FormData(form)
                });
                data = await response.json();
            } catch (error) {
                showToast('An error occurred. Please try again.', 'error');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = defaultButtonContent;
                }
                return;
            }

            const formContainer = document.getElementById('jobBoardModalFormContainer');

            if (response.ok && data?.success) {
                closeModal();
                showToast(data.message || 'Job board created successfully!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                formContainer.innerHTML = data?.modal;
                bindFormHandler();
                showToast(data?.message || 'Please fix the errors and try again.', 'error');
            }

            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = defaultButtonContent;
            }
        });
    };

    bindFormHandler();
});
</script>
